<section class="comments-section">
<!-- % if site.repository and site.staticman.branch % -->
{% if page.legacyslug.size > 0 %}
{% capture commentslug %}{{ page.legacyslug }}{% endcapture %}
{% else %}
{% capture commentslug %}{{ page.date | date: '%Y-%m-' | append: page.title | slugify }}{% endcapture %}
{% endif %}

{% if site.data.comments[commentslug] %}

    <!-- Start static comments -->
    <div id="comments" class="js-comments">
        <h2 class="page__section-label">
            {% if site.data.comments[page.slug].size > 1 %}
                {{ site.data.comments[page.slug] | size }}
            {% endif %}
            Comments
        </h2>

        {% assign comments = site.data.comments[commentslug] | sort %}
        {% for comment in comments %}
            {% assign id      = comment[1]._id %}
            {% assign index   = forloop.index %}
            {% assign p       = comment[1]._parent %}
            {% assign parent  = p | to_integer %}
            {% assign avatar  = comment[1].avatar %}
            {% assign email   = comment[1].authoremail %}
            {% assign name    = comment[1].author %}
            {% assign url     = comment[1].authorurl %}
            {% assign date    = comment[1].timestamp %}
            {% assign message = comment[1].text %}

            {% if p == commentslug or p == nil %}
              {% assign is_top_level = true %}
            {% else %}
              {% assign is_top_level = false %}
            {% endif %}

            {% if is_top_level %}
              {% include comment.html index=index id=id parent=parent avatar=avatar email=email name=name url=url date=date message=message %}

              {% unless page.comments_locked == true %}
              <a rel="nofollow"
                class="reply-button"
                href="#comment-{{ comment[1]._id }}"
                onclick="return addComment.moveForm('comment-{{ comment[1]._id }}', '{{ comment[1]._id }}', 'respond', '{{ commentslug }}')">
                Reply
              </a>
              {% endunless %}
            {% endif %}
        {% endfor %}

    </div>
    <!-- End static comments -->
{% endif %}

{% unless page.comments_locked == true %}
    <!-- Start new comment form -->
    <div id="respond">
        <header>
          <h2 class="page__section-label">Leave a Comment</h2>
          <a rel="nofollow" id="cancel-comment-reply-link" href="{{ page.url | absolute_url }}#respond" style="display:none;">
              Cancel replying (make this comment general)
          </a>
        </header>
        <p class="instruct">
        You can use <code>*<em>italics</em>*</code>, <code>**<strong>bold</strong>**</code>, and links: <code>[<u>link says this</u>](and goes to this address)</code>. Other fancy formatting possible via <a href="https://kramdown.gettalong.org/quickref.html">Markdown</a>.
        </p>
        <form id="comment-form" class="page__form js-form form" method="post" action="https://api.staticman.net/v2/entry/{{ site.repository }}/master/comments">
            <fieldset>
                <textarea type="text" rows="6" class="comment-message" id="comment-form-message" placeholder="Your comment" name="fields[text]" spellcheck="true"></textarea>
            </fieldset>
            <fieldset>
                <input type="text" id="comment-form-name" name="fields[author]" spellcheck="false" />
                <label for="comment-form-name">Name <span class="required">*</span></label>
            </fieldset>
            <fieldset>
                <input type="email" id="comment-form-email" name="fields[authoremail]" spellcheck="false" />
                <label for="comment-form-email">Email <small>(optional—for <a href="https://en.gravatar.com/">Gravatar</a>s and reply notifications)</small></label>
            </fieldset>
            <fieldset>
                <input type="url" id="comment-form-url" name="fields[authorurl]" spellcheck="false" />
                <label for="comment-form-url">Link to some online profile of yours <small>(optional)</small></label>
            </fieldset>
            <fieldset class="hidden" style="display:none;">
                <input type="hidden" name="options[origin]" value="{{ page.url | absolute_url }}">
                <input type="hidden" id="comment-parent" name="options[parent]" 
                       value="{{ commentslug }}" data-initial-value="{{ commentslug }}">
                <input type="hidden" id="comment-post-id" name="options[slug]" value="{{ commentslug }}">
                <label for="comment-form-location">Leave blank if you are a human</label>
                <input type="text" id="comment-form-location" name="fields[hidden]" autocomplete="off"/>
            </fieldset>
            <!-- Start comment form alert messaging -->
            <p class="hidden js-notice">
            <span id="js-notice-success" class="js-notice-text hidden">
              <strong>Thanks for your comment!</strong> It will show on the site once it’s been processed.
            </span>
            <span id="js-notice-failure" class="js-notice-text hidden">
              <strong>Sorry, there was an error submitting your comment.</strong> Please make sure all the
              required fields are filled in and try again. If it still won't work, you can
              <a href="/manual-comment?slug={{ commentslug | uri_encode }}">comment manually.</a>
            </span>
            </p>
            <!-- End comment form alert messaging -->
            <fieldset>
                <button type="submit" id="comment-form-submit" class="button">Submit Comment</button>
                <input type="checkbox" id="subscribe-field" name="options[subscribe]" value="authoremail">
                <label for="subscribe-field">Email me when someone else comments on this post <small>(unsubscribable)</small></label>
            </fieldset>
        </form>
    </div>
    <!-- End new comment form -->
{% else %}
    <p><em>Comments are closed. If you have a question concerning the content of this page, please feel free to <a href="{{ site.url }}/contact/">contact me</a>.</em></p>
{% endunless %}
<!-- % endif % !-->
</section>

